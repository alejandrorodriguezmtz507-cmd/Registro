<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner QR + Alerta Telegram</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
  body {font-family:Arial,sans-serif;background:#101820;color:#fff;padding:14px;text-align:center;}
  #reader {width:100%;max-width:420px;margin:auto;border-radius:12px;overflow:hidden;background:#000;padding:8px;}
  button {margin:6px;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;}
  .btn-start{background:#00e676;color:#003300;}
  .btn-stop{background:#e53935;color:#fff;}
  .btn-alert{background:#0277bd;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;}
  .btn-send-all{background:#ffb300;color:#000;padding:8px 12px;border-radius:10px;}
  .btn-delete-all{background:#f44336;color:#fff;padding:8px 12px;border-radius:10px;}
  table{width:100%;max-width:850px;margin:14px auto;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:center;font-size:14px;}
  th{background:#1b2a40;}
  #status{margin-top:8px;color:#9fc7d9;min-height:20px;}
  #hint{font-size:13px;color:#cbd8e6;margin-bottom:10px;}
  .small{font-size:12px;color:#9aa9b8;}
</style>
</head>
<body>
<h2>üì± Esc√°ner QR + Env√≠o de alerta a Telegram</h2>
<p id="hint">Escanea c√≥digos QR con formato JSON, por ejemplo:<br><code>{"nombre":"Juan P√©rez","telefono":"5544332211"}</code></p>

<div id="reader"></div>

<div style="margin-top:10px;">
  <button id="startBtn" class="btn-start">Iniciar escaneo</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
  <button id="sendAllBtn" class="btn-send-all">üì§ Enviar todo a Telegram</button>
  <button id="deleteAllBtn" class="btn-delete-all">üóëÔ∏è Borrar todo</button>
</div>

<h3>üìã Registros</h3>
<table>
  <thead><tr><th>#</th><th>Nombre</th><th>Tel√©fono</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<p id="status">Listo.</p>

<script>
/* === CONFIGURA TU BOT AQU√ç === */
const BOT_TOKEN = "7753210477:AAFmRv9Z-LR4Kk354FiP_0Vq167ajOKx2Y8";
const CHAT_IDS = [8290866315]; // Puedes agregar m√°s IDs separados por coma
const STORAGE_KEY = "registros_qr_telegram_v2";
/* ============================== */

let html5QrCode = null;
let isScanning = false;
let alreadyScanned = false;

function log(msg,isError=false){
  console.log("[APP]",msg);
  const s=document.getElementById('status');
  s.textContent=msg;
  s.style.color=isError?"#ffcccb":"#9fc7d9";
}

function hora(){return new Date().toLocaleString('es-MX',{hour12:false});}
function cargarDatos(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");}catch(e){return [];}}
function guardar(r){const d=cargarDatos();d.unshift(r);localStorage.setItem(STORAGE_KEY,JSON.stringify(d));}

function mostrar(){
  const data=cargarDatos();
  const tb=document.getElementById('tableBody');
  tb.innerHTML="";
  data.forEach((r,i)=>{
    tb.innerHTML+=`
    <tr>
      <td>${i+1}</td>
      <td>${r.nombre}</td>
      <td>${r.telefono}</td>
      <td>${r.hora}</td>
      <td>
        <button class="btn-alert" onclick="enviar(${i})">üì© Enviar</button>
        <button style="background:#f44336;color:#fff;padding:6px 8px;border-radius:8px;" onclick="eliminar(${i})">üóëÔ∏è</button>
      </td>
    </tr>`;
  });
}

/* ===== ELIMINAR UN REGISTRO ===== */
function eliminar(i){
  const data=cargarDatos();
  if(!data[i])return;
  if(confirm(`¬øEliminar el registro de ${data[i].nombre}?`)){
    data.splice(i,1);
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
    mostrar();
    log("Registro eliminado");
  }
}

/* ===== ELIMINAR TODOS ===== */
document.getElementById('deleteAllBtn').onclick=()=>{
  if(confirm("¬øSeguro que quieres eliminar todos los registros?")){
    localStorage.removeItem(STORAGE_KEY);
    mostrar();
    log("Todos los registros eliminados");
  }
}

/* ===== ENVIAR UN REGISTRO ===== */
async function enviar(i){
  const data=cargarDatos();
  const r=data[i];
  if(!r)return alert("No existe el registro.");
  const mensaje=`üöç Registro escaneado:\nüë§ ${r.nombre}\nüì± ${r.telefono}\nüïí ${r.hora}`;
  await enviarTelegram(mensaje);
}

/* ===== ENVIAR MENSAJE A TELEGRAM ===== */
async function enviarTelegram(mensaje){
  for(const chat of CHAT_IDS){
    const url=`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chat}&text=${encodeURIComponent(mensaje)}`;
    try{
      const res=await fetch(url);
      if(res.ok){log(`‚úÖ Enviado a ${chat}`);}
      else{throw new Error("Error al enviar");}
    }catch(e){
      console.warn("Error Telegram:",e);
      log("‚ö†Ô∏è Error de conexi√≥n. Intentando abrir directamente...");
      window.open(url,"_blank");
    }
  }
}

/* ===== ENVIAR TODOS LOS REGISTROS ===== */
document.getElementById('sendAllBtn').onclick=async()=>{
  const data=cargarDatos();
  if(!data.length)return alert("No hay registros para enviar.");
  if(!confirm(`¬øEnviar ${data.length} registros a Telegram?`))return;
  for(const r of data){
    const msg=`üöç Registro escaneado:\nüë§ ${r.nombre}\nüì± ${r.telefono}\nüïí ${r.hora}`;
    await enviarTelegram(msg);
    await new Promise(r=>setTimeout(r,500));
  }
  alert("Env√≠o finalizado ‚úÖ");
}

/* ===== ESCANEO ===== */
async function procesar(decodedText){
  if(alreadyScanned)return;
  alreadyScanned=true;

  // Vibraci√≥n al escanear
  if(navigator.vibrate)navigator.vibrate(300);

  try{
    const data=JSON.parse(decodedText);
    const r={
      nombre:data.nombre||data.name||decodedText,
      telefono:data.telefono||data.phone||"",
      hora:hora()
    };
    guardar(r); mostrar(); log("‚úÖ Registro guardado: "+r.nombre);
  }catch(e){log("‚ö†Ô∏è QR inv√°lido",true);}

  // Detiene autom√°ticamente el escaneo
  setTimeout(detenerEscaneo,700);
}

async function detenerEscaneo(){
  if(isScanning && html5QrCode){
    try{
      await html5QrCode.stop();
      await html5QrCode.clear();
    }catch(e){console.warn("Error detener:",e);}
    isScanning=false;
    document.getElementById('startBtn').disabled=false;
    document.getElementById('stopBtn').disabled=true;
    log("üì¥ Escaneo detenido");
  }
}

/* ===== BOTONES ===== */
document.getElementById('startBtn').onclick=async()=>{
  if(isScanning)return;
  alreadyScanned=false;
  html5QrCode=new Html5Qrcode("reader");
  try{
    const devices=await Html5Qrcode.getCameras();
    if(devices && devices.length){
      let cameraId=devices[0].id;
      for(const d of devices){
        const label=(d.label||"").toLowerCase();
        if(label.includes("back")||label.includes("rear")||label.includes("tras")){cameraId=d.id;break;}
      }
      await html5QrCode.start(cameraId,{fps:10,qrbox:250},procesar);
      isScanning=true;
      document.getElementById('startBtn').disabled=true;
      document.getElementById('stopBtn').disabled=false;
      log("üì∑ Escaneando...");
    }else{log("‚ö†Ô∏è No se encontr√≥ c√°mara",true);}
  }catch(err){log("Error al iniciar c√°mara: "+err.message,true);}
};

document.getElementById('stopBtn').onclick=detenerEscaneo;

/* ===== INICIO ===== */
mostrar();
window.enviar=enviar;
window.eliminar=eliminar;
</script>
</body>
</html>
