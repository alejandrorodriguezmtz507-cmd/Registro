<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner QR + Alerta Telegram</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
  body {font-family:Arial,sans-serif;background:#101820;color:#fff;padding:14px;text-align:center;}
  #reader {width:100%;max-width:420px;margin:auto;border-radius:12px;overflow:hidden;background:#000;padding:8px;}
  button {margin:6px;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;}
  .btn-start{background:#00e676;color:#003300;}
  .btn-stop{background:#e53935;color:#fff;}
  .btn-alert{background:#0277bd;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;}
  .btn-send-all{background:#ffb300;color:#000;padding:8px 12px;border-radius:10px;}
  .btn-delete-all{background:#d32f2f;color:#fff;padding:8px 12px;border-radius:10px;}
  table{width:100%;max-width:850px;margin:14px auto;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:center;font-size:14px;}
  th{background:#1b2a40;}
  #status{margin-top:8px;color:#9fc7d9;min-height:20px;}
  #hint{font-size:13px;color:#cbd8e6;margin-bottom:10px;}
  .small{font-size:12px;color:#9aa9b8;}
</style>
</head>
<body>
<h2>üì± Esc√°ner QR + Env√≠o de alerta a Telegram</h2>

<div id="reader"></div>

<div style="margin-top:10px;">
  <button id="startBtn" class="btn-start">Iniciar escaneo</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
  <button id="sendAllBtn" class="btn-send-all">üì§ Enviar todo a Telegram</button>
  <button id="deleteAllBtn" class="btn-delete-all">üóëÔ∏è Eliminar todos</button>
</div>

<h3>üìã Registros</h3>
<table>
  <thead><tr><th>#</th><th>Nombre</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<p id="status">Listo.</p>
<p class="small">Nota: Si tu bot o chat id son correctos, el mensaje debe llegar. Si el navegador bloquea CORS, se abrir√° la URL en una nueva pesta√±a.</p>

<script>
const BOT_TOKEN = "7753210477:AAFmRv9Z-LR4Kk354FiP_0Vq167ajOKx2Y8";
const CHAT_IDS = [8290866315];
const STORAGE_KEY = "registros_qr_telegram_v2";

let html5QrCode = null;
let isScanning = false;
let alreadyScanned = false;

function log(msg, isError=false){
  console.log("[APP]", msg);
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = isError ? "#ffcccb" : "#9fc7d9";
}

function hora(){
  const d = new Date();
  return d.toLocaleString('es-MX', { hour12:false });
}

function cargarDatos(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch(e){ return []; }
}

function guardar(r){
  const data = cargarDatos();
  data.unshift(r);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function mostrar(){
  const data = cargarDatos();
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  data.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(r.nombre)}</td>
      <td>${escapeHtml(r.hora)}</td>
      <td>
        <button class="btn-alert" onclick="enviar(${i})">üì© Enviar</button>
        <button style="margin-left:6px;padding:6px;border-radius:8px" onclick="eliminar(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function escapeHtml(text){
  return (text+"").replace(/[&<>"'`=\/]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;','=':'&#x3D;'}[s]));
}

function eliminar(idx){
  const data = cargarDatos();
  if(!data[idx]) return;
  if(!confirm(`Eliminar registro:\n${data[idx].nombre}?`)) return;
  data.splice(idx,1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  mostrar();
  log("Registro eliminado");
}

document.getElementById('deleteAllBtn').onclick = ()=>{
  if(confirm("¬øEliminar todos los registros? Esta acci√≥n no se puede deshacer.")){
    localStorage.removeItem(STORAGE_KEY);
    mostrar();
    log("Todos los registros eliminados");
  }
};

/* Solo procesa nombre y hora */
async function procesar(decodedText){
  if(alreadyScanned) return; // Evita m√∫ltiples lecturas
  alreadyScanned = true;
  try {
    let parsed;
    try { parsed = JSON.parse(decodedText); } catch(e) { parsed = null; }
    const nombre = parsed?.nombre || decodedText;
    const registro = { nombre: String(nombre).trim(), hora: hora() };
    guardar(registro);
    mostrar();
    log("‚úÖ Registro guardado: " + registro.nombre);

    // Vibrar al escanear
    if(navigator.vibrate) navigator.vibrate(200);

    // Detener c√°mara despu√©s del primer escaneo
    await detenerEscaneo();

  } catch(e){
    log("‚ö†Ô∏è Error al procesar QR: " + e.message, true);
  }
}

async function enviar(idx){
  const data = cargarDatos();
  const r = data[idx];
  if(!r){ alert("No existe el registro"); return; }
  const mensaje = `üìã Registro escaneado:\nüë§ ${r.nombre}\nüïí ${r.hora}`;
  await enviarMensajeATodos(mensaje);
}

async function enviarMensajeATodos(mensaje){
  for(const chat of CHAT_IDS){
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chat}&text=${encodeURIComponent(mensaje)}`;
    const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
    try{
      const res = await fetch(proxy);
      if(res.ok){ log(`‚úÖ Enviado a ${chat}`); }
      else window.open(url, "_blank");
    }catch{ window.open(url, "_blank"); }
  }
  alert("Mensaje enviado. Verifica Telegram.");
}

document.getElementById('sendAllBtn').onclick = async ()=>{
  const data = cargarDatos();
  if(!data.length){ alert("No hay registros."); return; }
  if(!confirm(`Enviar ${data.length} registros a Telegram?`)) return;
  for(const r of data){
    const msg = `üìã Registro escaneado:\nüë§ ${r.nombre}\nüïí ${r.hora}`;
    await enviarMensajeATodos(msg);
    await new Promise(r=>setTimeout(r,400));
  }
};

/* Escaneo */
document.getElementById('startBtn').onclick = async ()=>{
  if(isScanning) return;
  alreadyScanned = false;
  html5QrCode = new Html5Qrcode("reader");
  try{
    const devices = await Html5Qrcode.getCameras();
    if(!devices.length) return alert("No se encontr√≥ c√°mara.");
    let camId = devices.find(d=>/(back|rear|tras|post|principal)/i.test(d.label))?.id || devices[0].id;
    await html5QrCode.start(camId, { fps:10, qrbox:250 }, procesar);
    isScanning = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    log("üì∑ Escaneando...");
  }catch(e){ alert("Error c√°mara: " + e.message); }
};

async function detenerEscaneo(){
  if(isScanning && html5QrCode){
    await html5QrCode.stop();
    await html5QrCode.clear();
    isScanning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    log("C√°mara detenida");
  }
}

document.getElementById('stopBtn').onclick = detenerEscaneo;

mostrar();
window.enviar = enviar;
window.eliminar = eliminar;
</script>
</body>
</html>
