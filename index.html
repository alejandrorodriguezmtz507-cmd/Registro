<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Esc√°ner QR + Alerta Telegram</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
  body {font-family:Arial,sans-serif;background:#101820;color:#fff;padding:14px;text-align:center;}
  #reader {width:100%;max-width:420px;margin:auto;border-radius:12px;overflow:hidden;background:#000;padding:8px;}
  button {margin:6px;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;}
  .btn-start{background:#00e676;color:#003300;}
  .btn-stop{background:#e53935;color:#fff;}
  .btn-alert{background:#0277bd;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;}
  .btn-send-all{background:#ffb300;color:#000;padding:8px 12px;border-radius:10px;}
  table{width:100%;max-width:850px;margin:14px auto;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:center;font-size:14px;}
  th{background:#1b2a40;}
  #status{margin-top:8px;color:#9fc7d9;min-height:20px;}
  #hint{font-size:13px;color:#cbd8e6;margin-bottom:10px;}
  .small{font-size:12px;color:#9aa9b8;}
</style>
</head>
<body>
<h2>üì± Esc√°ner QR + Env√≠o de alerta a Telegram</h2>
<p id="hint">Escanea c√≥digos QR con formato JSON, por ejemplo:<br><code>{"nombre":"Juan P√©rez","telefono":"5544332211"}</code></p>

<div id="reader"></div>

<div style="margin-top:10px;">
  <button id="startBtn" class="btn-start">Iniciar escaneo</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
  <button id="sendAllBtn" class="btn-send-all">üì§ Enviar todo a Telegram</button>
</div>

<h3>üìã Registros</h3>
<table>
  <thead><tr><th>#</th><th>Nombre</th><th>Tel√©fono</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<p id="status">Listo.</p>
<p class="small">Nota: si tu bot o chat id son correctos, el mensaje debe llegar. Si el navegador bloquea CORS, se abrir√° la URL en una nueva pesta√±a como fallback.</p>

<script>
/*
  CONFIGURACI√ìN:
  - PON TU TOKEN AQU√ç (sin espacios extra).
  - PON LOS CHAT_IDS como n√∫meros (sin comillas) o como strings.
  - EJEMPLO:
      const BOT_TOKEN = "123456:ABC-DEF..."; 
      const CHAT_IDS = [123456789, 987654321];
*/
const BOT_TOKEN = "7753210477:AAFmRv9Z-LR4Kk354FiP_0Vq167ajOKx2Y8"; // <- quita espacios extra si los hubiera
const CHAT_IDS = [8290866315]; // <- agrega los IDs que necesites

const STORAGE_KEY = "registros_qr_telegram_v1";

let html5QrCode = null;
let isScanning = false;

function log(msg, isError=false){
  console.log("[APP]", msg);
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = isError ? "#ffcccb" : "#9fc7d9";
}

function hora(){
  const d = new Date();
  return d.toLocaleString('es-MX', { hour12:false });
}

function cargarDatos(){
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  } catch(e) {
    return [];
  }
}

function guardar(r){
  const data = cargarDatos();
  // evita duplicados inmediatos (mismo nombre+tel y misma hora)
  const existe = data.find(x => x.nombre === r.nombre && x.telefono === r.telefono && x.hora === r.hora);
  if(!existe) {
    data.unshift(r);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
}

function mostrar(){
  const data = cargarDatos();
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  data.forEach((r,i)=>{
    const idx = i;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(r.nombre)}</td>
      <td>${escapeHtml(r.telefono)}</td>
      <td>${escapeHtml(r.hora)}</td>
      <td>
        <button class="btn-alert" onclick="enviar(${idx})">üì© Enviar</button>
        <button style="margin-left:6px;padding:6px;border-radius:8px" onclick="eliminar(${idx})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function escapeHtml(text){
  return (text+"").replace(/[&<>"'`=\/]/g, function(s) {
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#x60;','/':'&#x2F;','=':'&#x3D;'}[s];
  });
}

function eliminar(idx){
  const data = cargarDatos();
  if(!data[idx]) return;
  if(!confirm(`Eliminar registro:\n${data[idx].nombre} ‚Äî ${data[idx].telefono}?`)) return;
  data.splice(idx,1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  mostrar();
  log("Registro eliminado");
}

/* Procesa texto decodificado del QR. Firma usada por Html5Qrcode:
   onScanSuccess(decodedText, decodedResult)
*/
function procesar(decodedText, decodedResult) {
  // decodedText es string -> intentamos parsearlo como JSON
  try {
    let parsed;
    try { parsed = JSON.parse(decodedText); } catch(e) { parsed = null; }
    const nombre = (parsed && (parsed.nombre || parsed.name)) ? (parsed.nombre || parsed.name) : decodedText;
    const telefono = (parsed && (parsed.telefono || parsed.phone || parsed.telefone)) ? (parsed.telefono || parsed.phone || parsed.telefone) : "";
    const registro = { nombre: String(nombre).trim(), telefono: String(telefono).trim(), hora: hora() };
    guardar(registro);
    mostrar();
    log("‚úÖ Registro guardado: " + registro.nombre);
    // opcional: enviar autom√°ticamente (descomentar si quieres env√≠o autom√°tico)
    // enviarUltimo();
  } catch(e){
    log("‚ö†Ô∏è Error al procesar QR: " + e.message, true);
  }
}

/* Enviar un registro(s) a Telegram.
   Usamos ALL ORIGINS como proxy para evitar CORS; si falla, abrimos la URL directa en nueva pesta√±a.
*/
async function enviar(idx){
  const data = cargarDatos();
  const r = data[idx];
  if(!r){ alert("No existe el registro"); return; }
  const mensaje = `üöç Registro escaneado:\nüë§ ${r.nombre}\nüì± ${r.telefono}\nüïí ${r.hora}`;
  await enviarMensajeATodos(mensaje);
}

async function enviarMensajeATodos(mensaje){
  if(!BOT_TOKEN || !CHAT_IDS || CHAT_IDS.length === 0){
    alert("Falta configurar BOT_TOKEN o CHAT_IDS en el c√≥digo.");
    return;
  }
  for(const chat of CHAT_IDS){
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chat}&text=${encodeURIComponent(mensaje)}`;
    // proxy para evitar CORS (fallback abierto)
    const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
    try{
      const res = await fetch(proxy, { method: "GET" });
      if(res.ok){
        // Telegram responde JSON; lo ignoramos, solo chequeamos OK
        log(`‚úÖ Enviado a ${chat}`);
      } else {
        // fallback: intentar abrir la url en nueva pesta√±a (user will need to approve)
        log(`‚ö†Ô∏è Proxy fall√≥ (status ${res.status}). Abriendo URL directa...`, true);
        window.open(url, "_blank");
      }
    }catch(e){
      // probablemente CORS o proxy ca√≠do -> fallback
      console.warn("Error fetch proxy:", e);
      log("‚ö†Ô∏è No se pudo usar el proxy. Abriendo URL directa...", true);
      window.open(url, "_blank");
    }
  }
  alert("Intento de env√≠o realizado. Revisa tu Telegram.");
}

/* Enviar todo */
document.getElementById('sendAllBtn').addEventListener('click', async ()=>{
  const data = cargarDatos();
  if(!data.length){ alert("No hay registros para enviar."); return; }
  if(!confirm(`Enviar ${data.length} registros a los chat(s) configurados?`)) return;
  for(const r of data){
    const mensaje = `üöç Registro escaneado:\nüë§ ${r.nombre}\nüì± ${r.telefono}\nüïí ${r.hora}`;
    await enviarMensajeATodos(mensaje);
    // ligera pausa entre mensajes (evita bloqueos)
    await new Promise(res=>setTimeout(res, 500));
  }
});

/* Botones start/stop y selecci√≥n de c√°mara trasera si existe */
document.getElementById('startBtn').onclick = async ()=>{
  if(isScanning) return;
  html5QrCode = new Html5Qrcode("reader");
  try{
    const devices = await Html5Qrcode.getCameras();
    if(devices && devices.length){
      // intentar elegir la c√°mara trasera por heur√≠stica en label (back, rear, trasera)
      let cameraId = devices[0].id;
      for(const d of devices){
        const label = (d.label||"").toLowerCase();
        if(label.includes("back") || label.includes("rear") || label.includes("tras") || label.includes("post") || label.includes("principal")){
          cameraId = d.id;
          break;
        }
      }
      await html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250, aspectRatio: 1.333 },
        procesar,
        (errorMessage) => { /* onScanError - opcional */ }
      );
      isScanning = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      log("üì∑ Escaneando...");
    } else {
      log("‚ö†Ô∏è No se encontr√≥ c√°mara", true);
      alert("No se encontr√≥ ninguna c√°mara disponible.");
    }
  }catch(err){
    console.error("Error al iniciar c√°mara:", err);
    if(err && /PermissionDenied|NotAllowedError/i.test(err.message || "")){
      log("Permiso de c√°mara denegado. Revisa permisos del navegador.", true);
      alert("Permiso de c√°mara denegado. Activa permisos y recarga la p√°gina.");
    } else {
      log("Error al iniciar c√°mara: " + (err.message || err), true);
      alert("Error al iniciar la c√°mara: " + (err.message || err));
    }
  }
};

document.getElementById('stopBtn').onclick = async ()=>{
  if(isScanning && html5QrCode){
    try{
      await html5QrCode.stop();
      await html5QrCode.clear();
    }catch(e){ console.warn("Error al detener:", e); }
    isScanning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    log("C√°mara detenida");
  }
};

/* Mostrar registros al cargar */
mostrar();

/* Permitir invocar enviar desde HTML inline (porque mostramos botones con onclick en la tabla) */
window.enviar = enviar;
window.eliminar = eliminar;
</script>
</body>
</html>
