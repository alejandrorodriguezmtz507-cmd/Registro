<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escáner QR + Alerta Telegram</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
body{font-family:Arial;background:#0f172a;color:#fff;text-align:center;padding:10px}
#reader{width:100%;max-width:380px;margin:auto;border-radius:12px;overflow:hidden}
button{margin:6px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:bold}
.btn-start{background:#00c853;color:white}
.btn-stop{background:#d32f2f;color:white}
.btn-clear{background:#ff9800;color:white}
#status{margin-top:10px;font-size:14px;color:#a9c7d2}
table{width:100%;max-width:500px;margin:auto;margin-top:15px;border-collapse:collapse}
th,td{border-bottom:1px solid rgba(255,255,255,0.2);padding:6px;font-size:13px}
th{background:#1c2a4a}
td{color:#e2e8f0}
</style>
</head>
<body>
<h2>📷 Escáner QR - Registro con Alerta Telegram</h2>
<p>Escanea un QR con nombre y teléfono. Se enviará alerta a Telegram automáticamente.</p>

<div id="reader"></div>
<div>
  <button id="startBtn" class="btn-start">Iniciar cámara</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
  <button id="clearBtn" class="btn-clear">Borrar registros</button>
</div>
<p id="status">Listo para iniciar</p>

<h3>📋 Registros</h3>
<table>
  <thead><tr><th>Nombre</th><th>Teléfono</th><th>Hora</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const BOT_TOKEN = "8188740505:AAFMJio9moB3PtypRlqMHrCobmTVTRo7Vy0  ";  // 🟢 Coloca aquí el token de tu bot
const CHAT_IDS = [8290866315]; // 🟢 IDs de usuarios a notificar

const STORAGE_KEY = "qr_registros_v2";
let html5QrCode;
let isScanning = false;

function cargarRegistros(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]}catch(e){return[]}}
function guardarRegistros(arr){localStorage.setItem(STORAGE_KEY,JSON.stringify(arr))}

function mostrarTabla(){
  const tbody=document.getElementById('tableBody');
  const registros=cargarRegistros();
  tbody.innerHTML="";
  if(registros.length===0){
    tbody.innerHTML=`<tr><td colspan="3" style="opacity:0.7">Sin registros</td></tr>`;
  }else{
    registros.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.nombre}</td><td>${r.telefono}</td><td>${r.hora}</td>`;
      tbody.appendChild(tr);
    });
  }
}

function obtenerHora(){
  const d=new Date();
  return d.toLocaleString('es-MX',{hour12:false});
}

function enviarTelegram(nombre,telefono,hora){
  const mensaje = `🚍 Registro detectado:\n👤 ${nombre}\n📱 ${telefono || "Sin teléfono"}\n🕒 ${hora}`;
  CHAT_IDS.forEach(id=>{
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:id,text:mensaje})
    }).catch(err=>console.error("Error enviando a Telegram:",err));
  });
}

function procesarQR(txt){
  let nombre="",telefono="";
  try{
    const data=JSON.parse(txt);
    nombre=data.nombre||data.name||txt;
    telefono=data.telefono||data.phone||"";
  }catch(e){nombre=txt}
  const hora=obtenerHora();
  const registro={nombre,telefono,hora};
  const registros=cargarRegistros();
  registros.unshift(registro);
  guardarRegistros(registros);
  mostrarTabla();

  document.getElementById('status').textContent=`✅ Escaneado: ${nombre} (${telefono||"sin teléfono"}) a las ${hora}`;
  navigator.vibrate?.(120);
  enviarTelegram(nombre,telefono,hora);
}

async function startCamera(){
  if(isScanning)return;
  const status=document.getElementById('status');
  try{
    html5QrCode=new Html5Qrcode("reader");
    const config={fps:10,qrbox:{width:250,height:250}};
    await html5QrCode.start({facingMode:{exact:"environment"}},config,qrText=>{procesarQR(qrText)});
    isScanning=true;
    status.textContent="Escaneando... apunta al QR";
    document.getElementById('startBtn').disabled=true;
    document.getElementById('stopBtn').disabled=false;
  }catch(err){
    status.textContent="⚠️ Error al iniciar cámara: "+err.message;
    alert("No se pudo iniciar la cámara.\nActiva permisos o usa HTTPS.");
  }
}

async function stopCamera(){
  const status=document.getElementById('status');
  if(html5QrCode&&isScanning){
    await html5QrCode.stop().catch(()=>{});
    await html5QrCode.clear();
    isScanning=false;
    document.getElementById('startBtn').disabled=false;
    document.getElementById('stopBtn').disabled=true;
    status.textContent="Cámara detenida.";
  }
}

function limpiarRegistros(){
  if(confirm("¿Borrar todos los registros?")){
    localStorage.removeItem(STORAGE_KEY);
    mostrarTabla();
  }
}

document.getElementById('startBtn').onclick=startCamera;
document.getElementById('stopBtn').onclick=stopCamera;
document.getElementById('clearBtn').onclick=limpiarRegistros;

mostrarTabla();
</script>
</body>
</html>
