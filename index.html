<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Escáner QR + Alerta Telegram</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
  body {font-family:Arial,sans-serif;background:#101820;color:#fff;padding:14px;text-align:center;}
  #reader {width:100%;max-width:420px;margin:auto;border-radius:12px;overflow:hidden;background:#000;padding:8px;}
  button {margin:6px;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:700;}
  .btn-start{background:#00e676;color:#003300;}
  .btn-stop{background:#e53935;color:#fff;}
  .btn-alert{background:#0277bd;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;}
  .btn-send-all{background:#ffb300;color:#000;padding:8px 12px;border-radius:10px;}
  table{width:100%;max-width:850px;margin:14px auto;border-collapse:collapse;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:center;font-size:14px;}
  th{background:#1b2a40;}
  #status{margin-top:8px;color:#9fc7d9;min-height:20px;}
  #hint{font-size:13px;color:#cbd8e6;margin-bottom:10px;}
  .small{font-size:12px;color:#9aa9b8;}
</style>
</head>
<body>
<h2>📱 Escáner QR + Envío de alerta a Telegram</h2>
<p id="hint">Escanea códigos QR con formato JSON, por ejemplo:<br><code>{"nombre":"Juan Pérez","telefono":"5544332211"}</code></p>

<div id="reader"></div>

<div style="margin-top:10px;">
  <button id="startBtn" class="btn-start">Iniciar escaneo</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
  <button id="sendAllBtn" class="btn-send-all">📤 Enviar todo a Telegram</button>
</div>

<h3>📋 Registros</h3>
<table>
  <thead><tr><th>#</th><th>Nombre</th><th>Teléfono</th><th>Hora</th><th>Acción</th></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<p id="status">Listo.</p>

<script>
const BOT_TOKEN = "7753210477:AAFmRv9Z-LR4Kk354FiP_0Vq167ajOKx2Y8";
const CHAT_IDS = [8290866315];
const STORAGE_KEY = "registros_qr_telegram_v1";

let html5QrCode = null;
let isScanning = false;
let alreadyScanned = false; // 🔸 Nueva bandera para evitar múltiples lecturas

function log(msg,isError=false){
  console.log("[APP]",msg);
  const s=document.getElementById('status');
  s.textContent=msg;
  s.style.color=isError?"#ffcccb":"#9fc7d9";
}

function hora(){return new Date().toLocaleString('es-MX',{hour12:false});}
function cargarDatos(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");}catch(e){return [];}}
function guardar(r){const d=cargarDatos();d.unshift(r);localStorage.setItem(STORAGE_KEY,JSON.stringify(d));}
function mostrar(){
  const data=cargarDatos(),tb=document.getElementById('tableBody');
  tb.innerHTML="";
  data.forEach((r,i)=>tb.innerHTML+=`<tr>
  <td>${i+1}</td><td>${r.nombre}</td><td>${r.telefono}</td><td>${r.hora}</td>
  <td><button class="btn-alert" onclick="enviar(${i})">📩 Enviar</button></td></tr>`);
}
async function enviar(idx){
  const data=cargarDatos();const r=data[idx];
  if(!r)return alert("No existe el registro");
  const mensaje=`🚍 Registro escaneado:\n👤 ${r.nombre}\n📱 ${r.telefono}\n🕒 ${r.hora}`;
  for(const chat of CHAT_IDS){
    const url=`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chat}&text=${encodeURIComponent(mensaje)}`;
    const proxy="https://api.allorigins.win/raw?url="+encodeURIComponent(url);
    try{
      const res=await fetch(proxy);
      if(res.ok) log(`✅ Enviado a ${chat}`);
      else{throw new Error("Respuesta no OK");}
    }catch(e){
      log("⚠️ Error al enviar: "+e.message,true);
      window.open(url,"_blank");
    }
  }
  alert("Mensaje enviado o en intento. Revisa Telegram.");
}

async function procesar(decodedText){
  if(alreadyScanned) return; // 🔸 Evita duplicados
  alreadyScanned = true; // marca como escaneado

  // 🔸 Vibra el dispositivo al escanear
  if (navigator.vibrate) navigator.vibrate(300);

  try{
    const data = JSON.parse(decodedText);
    const r = {
      nombre: data.nombre || data.name || decodedText,
      telefono: data.telefono || data.phone || "",
      hora: hora()
    };
    guardar(r); mostrar(); log("✅ Registro guardado: "+r.nombre);
  }catch(e){
    log("⚠️ Código QR inválido",true);
  }

  // 🔸 Detiene el escaneo automáticamente tras un resultado
  setTimeout(detenerEscaneo, 800);
}

async function detenerEscaneo(){
  if(isScanning && html5QrCode){
    try{
      await html5QrCode.stop();
      await html5QrCode.clear();
    }catch(e){console.warn("Error al detener:",e);}
    isScanning=false;
    document.getElementById('startBtn').disabled=false;
    document.getElementById('stopBtn').disabled=true;
    log("📴 Escaneo detenido automáticamente.");
  }
}

document.getElementById('startBtn').onclick=async()=>{
  if(isScanning)return;
  alreadyScanned = false; // 🔸 Reset para nuevo escaneo
  html5QrCode = new Html5Qrcode("reader");
  try{
    const devices = await Html5Qrcode.getCameras();
    if(devices && devices.length){
      let cameraId = devices[0].id;
      for(const d of devices){
        const label=(d.label||"").toLowerCase();
        if(label.includes("back")||label.includes("rear")||label.includes("tras")){cameraId=d.id;break;}
      }
      await html5QrCode.start(cameraId,{fps:10,qrbox:250},procesar);
      isScanning=true;
      document.getElementById('startBtn').disabled=true;
      document.getElementById('stopBtn').disabled=false;
      log("📷 Escaneando...");
    }else{log("⚠️ No se encontró cámara",true);}
  }catch(err){log("Error al iniciar cámara: "+err.message,true);}
};

document.getElementById('stopBtn').onclick=detenerEscaneo;

document.getElementById('sendAllBtn').onclick=async()=>{
  const data=cargarDatos();
  if(!data.length)return alert("No hay registros para enviar.");
  if(!confirm(`Enviar ${data.length} registros a Telegram?`))return;
  for(const r of data){
    const msg=`🚍 Registro escaneado:\n👤 ${r.nombre}\n📱 ${r.telefono}\n🕒 ${r.hora}`;
    await enviarMensaje(msg); await new Promise(r=>setTimeout(r,500));
  }
};

async function enviarMensaje(mensaje){
  for(const chat of CHAT_IDS){
    const url=`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chat}&text=${encodeURIComponent(mensaje)}`;
    const proxy="https://api.allorigins.win/raw?url="+encodeURIComponent(url);
    try{await fetch(proxy);}catch{window.open(url,"_blank");}
  }
}

mostrar();
window.enviar=enviar;
</script>
</body>
</html>
