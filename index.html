<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escáner QR - Registro</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
body{font-family:Arial, sans-serif;background:#0f172a;color:#fff;text-align:center;padding:10px}
#reader{width:100%;max-width:380px;margin:auto;border-radius:12px;overflow:hidden}
button{margin:6px;padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:bold}
.btn-start{background:#00c853;color:white}
.btn-stop{background:#d32f2f;color:white}
#status{margin-top:10px;font-size:14px;color:#a9c7d2}
</style>
</head>
<body>
<h2>Escáner QR - Registro</h2>
<p>Permite acceso a la cámara cuando se te solicite.</p>

<div id="reader"></div>
<div>
  <button id="startBtn" class="btn-start">Iniciar cámara</button>
  <button id="stopBtn" class="btn-stop" disabled>Detener</button>
</div>
<p id="status">Listo para iniciar</p>

<script>
let html5QrCode;
let isScanning = false;

async function startCamera(){
  if (isScanning) return;
  const status = document.getElementById('status');
  try{
    html5QrCode = new Html5Qrcode("reader");
    const config = { 
      fps: 10, 
      qrbox: { width: 250, height: 250 },
      experimentalFeatures: { useBarCodeDetectorIfSupported: true }
    };
    await html5QrCode.start(
      { facingMode: { exact: "environment" } }, // cámara trasera
      config,
      qrCodeMessage => {
        status.textContent = "QR detectado: " + qrCodeMessage;
        navigator.vibrate?.(120);
        stopCamera();
      },
      errorMessage => { 
        // No muestra error cada frame
      }
    );
    isScanning = true;
    status.textContent = "Escaneando... apunta al QR.";
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
  }catch(err){
    console.error(err);
    status.textContent = "⚠️ Error al iniciar cámara: " + err.message;
    alert("No se pudo iniciar la cámara.\nActiva permisos o usa HTTPS.");
  }
}

async function stopCamera(){
  const status = document.getElementById('status');
  if (html5QrCode && isScanning){
    await html5QrCode.stop().catch(()=>{});
    await html5QrCode.clear();
    isScanning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    status.textContent = "Cámara detenida.";
  }
}

document.getElementById('startBtn').onclick = startCamera;
document.getElementById('stopBtn').onclick = stopCamera;
</script>
</body>
</html>
