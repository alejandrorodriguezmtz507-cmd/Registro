<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registro QR (BarcodeDetector + Telegram)</title>
<style>
  :root{
    --bg:#071428; --card:#0b2540; --accent:#ff7a59; --glass: rgba(255,255,255,0.04);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{ margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg),#032233); color:#e6f7ff; display:flex; align-items:center; justify-content:center; padding:18px;}
  .app{ width:100%; max-width:980px; display:grid; grid-template-columns: 420px 1fr; gap:18px; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); border-radius:14px; padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03) }
  h1{ margin:0 0 8px 0; font-size:20px }
  #videoWrap{ width:100%; height:320px; border-radius:12px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative }
  video{ width:100%; height:100%; object-fit:cover }
  .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
  button{ background:linear-gradient(90deg,var(--accent),#ff5c4a); border:none; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
  select,input{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit }
  .muted{ color:#bfe9f7; opacity:0.85; font-size:13px }
  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:13px }
  th,td{ text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.03) }
  thead th{ color:#dbeffd; font-weight:700; font-size:12px }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:rgba(3,27,39,0.9); padding:10px 14px; border-radius:10px; color:#dff6ff; font-weight:700; box-shadow:0 8px 30px rgba(0,0,0,0.6) }
  @media(max-width:980px){ .app{ grid-template-columns:1fr } #videoWrap{ height:260px } }
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>EscÃ¡ner QR â€” Registro</h1>
      <div id="videoWrap">
        <video id="video" autoplay muted playsinline></video>
        <div id="noCamMsg" style="position:absolute; color:#bfe9f7; text-align:center; padding:12px; display:none">
          CÃ¡mara no iniciada
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; align-items:center; justify-content:space-between">
        <div style="display:flex; gap:8px; align-items:center">
          <label class="muted">CÃ¡mara:</label>
          <select id="cameraSelect"></select>
        </div>
        <div class="muted" id="statusText">Estado: esperando</div>
      </div>

      <div class="controls" style="margin-top:10px">
        <button id="startBtn">Iniciar</button>
        <button id="stopBtn" style="display:none;background:#ff6b6b">Detener</button>
        <button id="importBtn" style="background:#ffd166;color:#111">Importar imagen</button>
        <button id="clearBtn" style="background:#6be0a1;color:#053">Limpiar historial</button>
      </div>

      <div style="margin-top:12px" class="muted">
        <div>Detector nativo: <span id="detectorSupport">â€”</span></div>
        <div style="margin-top:6px">Si tu navegador NO soporta <code>BarcodeDetector</code>, la app te pedirÃ¡ usar la librerÃ­a externa o importar imagen.</div>
      </div>
    </div>

    <div class="card">
      <h1>Historial y contadores</h1>
      <div style="display:flex; gap:12px; margin-bottom:8px">
        <div style="flex:1">
          <div class="muted">Total</div>
          <div id="totalCount" style="font-size:26px;font-weight:800">0</div>
        </div>
        <div style="flex:1">
          <div class="muted">Ãšnicos</div>
          <div id="uniqueCount" style="font-size:26px;font-weight:800">0</div>
        </div>
        <div style="flex:1">
          <div class="muted">Hoy</div>
          <div id="todayCount" style="font-size:26px;font-weight:800">0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
        <input id="search" placeholder="Buscar por nombre o fecha" style="flex:1"/>
        <button id="searchClear" style="background:#c7f9e8;color:#053">Limpiar</button>
        <button id="exportCsv" style="background:#ffd166;color:#111">Exportar CSV</button>
      </div>

      <div style="max-height:420px; overflow:auto;">
        <table>
          <thead>
            <tr><th>Nombre</th><th>Fecha / Hora</th><th>Origen</th><th></th></tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px; color:#bfe9f7; font-size:13px">
        Guardado en <strong>localStorage</strong> del navegador â€” permanece en tu dispositivo.
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/* ---------- Config y storage ---------- */
const STORAGE_KEY = 'qr_registrations_v2';
let stream = null;
let currentTrack = null;
let processing = false;
let barcodeDetector = null;
let lastDetected = { text:null, ts:0 };

/* ---------- UI refs ---------- */
const video = document.getElementById('video');
const cameraSelect = document.getElementById('cameraSelect');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusText = document.getElementById('statusText');
const detectorSupport = document.getElementById('detectorSupport');
const historyBody = document.getElementById('historyBody');
const totalCountEl = document.getElementById('totalCount');
const uniqueCountEl = document.getElementById('uniqueCount');
const todayCountEl = document.getElementById('todayCount');
const toast = document.getElementById('toast');
const importBtn = document.getElementById('importBtn');
const clearBtn = document.getElementById('clearBtn');
const exportCsv = document.getElementById('exportCsv');
const searchInput = document.getElementById('search');
const searchClear = document.getElementById('searchClear');

/* ---------- Helpers ---------- */
function showToast(msg, t=1600){
  toast.textContent = msg;
  toast.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.style.display='none', t);
}
function nowLocal(){
  const d=new Date();
  return { iso:d.toISOString(), display: d.toLocaleString('es-MX', { hour12:false }) };
}
function loadScans(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){return []}}
function saveScans(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); refreshUI(); }

/* ---------- Telegram Bot ---------- */
const BOT_TOKEN = '8188740505:AAFMJio9moB3PtypRlqMHrCobmTVTRo7Vy0   ';
const CHAT_ID = '8290866315  ';

async function sendTelegramMessage(text){
  try{
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: CHAT_ID, text: text, parse_mode:'HTML' })
    });
  }catch(err){
    console.error('Error Telegram', err);
  }
}

/* ---------- Enviar lista completa al bot ---------- */
function sendFullListToTelegram(){
  const arr = loadScans();
  if (!arr.length) return;
  
  let msg = `ðŸ“‹ <b>Lista de registros escaneados:</b>\n\n`;
  arr.forEach((item,i)=>{
    msg += `${i+1}. <b>Nombre:</b> ${item.name}\n   <b>Origen:</b> ${item.origin}\n   <b>Fecha:</b> ${item.display}\n\n`;
  });
  
  sendTelegramMessage(msg);
}

/* ---------- Camera device list ---------- */
async function populateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((c,i)=> {
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || `CÃ¡mara ${i+1}`;
      cameraSelect.appendChild(opt);
    });
    return cams;
  }catch(e){
    console.error('enumerateDevices', e);
    return [];
  }
}

/* ---------- Start / Stop stream ---------- */
async function startStream(deviceId){
  stopStream();
  try{
    const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' } , audio:false };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    currentTrack = stream.getVideoTracks()[0];
    statusText.textContent = 'Estado: cÃ¡mara activa';
    processing = true;
    startDetectionLoop();
  }catch(err){
    console.error('getUserMedia', err);
    statusText.textContent = 'Estado: error cÃ¡mara';
    alert('Error al acceder a la cÃ¡mara: ' + (err.message || err));
  }
}
function stopStream(){
  processing = false;
  if (stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    currentTrack = null;
    video.srcObject = null;
  }
  statusText.textContent = 'Estado: detenido';
}

/* ---------- Detection loop usando BarcodeDetector ---------- */
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

async function startDetectionLoop(){
  if (!processing) return;
  if (!barcodeDetector){
    if ('BarcodeDetector' in window){
      try {
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        detectorSupport.textContent = 'SÃ­ (nativo)';
      } catch(e){
        console.warn('BarcodeDetector init failed', e);
        detectorSupport.textContent = 'No (error)';
      }
    } else {
      detectorSupport.textContent = 'No';
    }
  }

  async function loop(){
    if (!processing || !stream) return;
    if (video.readyState >= 2){
      const w = video.videoWidth, h = video.videoHeight;
      if (w && h){
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);
        try{
          if (barcodeDetector){
            const result = await barcodeDetector.detect(canvas);
            if (result && result.length){
              handleDetected(result[0].rawValue || result[0].rawData || JSON.stringify(result[0]));
            }
          }
        }catch(e){
          console.debug('detect error', e);
        }
      }
    }
    setTimeout(()=>{ if (processing) requestAnimationFrame(loop); }, 80);
  }
  loop();
}

/* ---------- Handle detection (debounce) ---------- */
function handleDetected(text){
  const now = Date.now();
  if (!text) return;
  if (lastDetected.text === text && (now - lastDetected.ts) < 2000) return;
  lastDetected = { text, ts: now };

  let name = text;
  try{
    const j = JSON.parse(text);
    if (j && typeof j === 'object' && (j.name || j.nombre)) name = j.name || j.nombre;
  }catch(e){}

  addScan(name, text, 'camara');
  showToast('Registrado: ' + name, 1400);
  navigator.vibrate?.(80);
}

/* ---------- Scans management ---------- */
function addScan(name, raw, origin='camara'){
  const ts = nowLocal();
  const item = { id:'s_' + Math.random().toString(36).slice(2,9), name, raw, origin, iso:ts.iso, display:ts.display };
  const arr = loadScans();
  arr.unshift(item);
  saveScans(arr);

  // Enviar lista completa al bot
  sendFullListToTelegram();
}

function refreshUI(){
  const arr = loadScans();
  const q = searchInput.value.trim().toLowerCase();
  const filtered = arr.filter(it => {
    if(!q) return true;
    return (it.name && it.name.toLowerCase().includes(q)) || (it.display && it.display.toLowerCase().includes(q)) || (it.raw && it.raw.toLowerCase().includes(q));
  });

  historyBody.innerHTML = '';
  if (filtered.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" style="color:#bfe9f7;padding:12px">No hay registros</td>`;
    historyBody.appendChild(tr);
  } else {
    filtered.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="font-weight:700">${escapeHtml(it.name)}</td><td class="muted">${escapeHtml(it.display)}</td><td class="muted">${escapeHtml(it.origin)}</td>
      <td style="text-align:right"><button data-id="${it.id}" class="delBtn" style="background:#ff6b6b;border:none;padding:6px 8px;border-radius:6px;color:#fff">Eliminar</button></td>`;
      historyBody.appendChild(tr);
    });
  }

  totalCountEl.textContent = arr.length;
  uniqueCountEl.textContent = new Set(arr.map(x => (x.name||'').toLowerCase())).size;
  const todayKey = new Date().toISOString().slice(0,10);
  todayCountEl.textContent = arr.filter(x => x.iso.slice(0,10) === todayKey).length;

  Array.from(document.getElementsByClassName('delBtn')).forEach(b=>{
    b.onclick = ()=> {
      if (!confirm('Eliminar registro?')) return;
      const id = b.dataset.id;
      const newArr = loadScans().filter(x=>x.id !== id);
      saveScans(newArr);
    };
  });
}

function escapeHtml(s=''){ return String(s).replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]); }

/* ---------- UI Events ---------- */
startBtn.addEventListener('click', async ()=>{
  const cams = await populateCameras();
  if (cams.length === 0){
    alert('No se detectaron cÃ¡maras. ConÃ©ctate a un dispositivo con cÃ¡mara o revisa permisos.');
    return;
  }
  const deviceId = cameraSelect.value || cams[0].deviceId;
  await startStream(deviceId);
  startBtn.style.display='none';
  stopBtn.style.display='inline-block';
});

stopBtn.addEventListener('click', ()=>{
  stopStream();
  startBtn.style.display='inline-block';
  stopBtn.style.display='none';
});

cameraSelect.addEventListener('change', async ()=>{
  if (stream) await startStream(cameraSelect.value);
});

importBtn.addEventListener('click', ()=> {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'image/*';
  inp.onchange = async e => {
    const f = e.target.files[0];
    if (!f) return;
    const img = new Image();
    img.onload = async () => {
      const w=img.width,h=img.height;
      canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0);
      try{
        if (barcodeDetector){
          const res = await barcodeDetector.detect(canvas);
          if (res && res.length) { handleDetected(res[0].rawValue||res[0].rawData); return; }
        }
        alert('No se detectÃ³ QR en la imagen o tu navegador no soporta BarcodeDetector.');
      }catch(err){ alert('Error procesando imagen: ' + (err.message||err)); }
    };
    img.src = URL.createObjectURL(f);
  };
  inp.click();
});

clearBtn.addEventListener('click', ()=>{
  if (!confirm('Borrar TODOS los registros?')) return;
  localStorage.removeItem(STORAGE_KEY);
  refreshUI();
});

exportCsv.addEventListener('click', ()=>{
  const arrexportCsv.addEventListener('click', ()=>{
  const arr = loadScans();
  if (!arr.length) { alert('Sin datos para exportar'); return; }
  const header = ['id','name','raw','origin','iso','display'];
  const rows = arr.map(r => header.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','));
  const csv = [header.join(','), ...rows].join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `qr_registros_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`; 
  a.click();
  URL.revokeObjectURL(url);
});

searchInput.addEventListener('input', refreshUI);
searchClear.addEventListener('click', ()=>{ searchInput.value=''; refreshUI; });

/* ---------- Init ---------- */
(async function init(){
  detectorSupport.textContent = ('BarcodeDetector' in window) ? 'Verificando...' : 'No';
  await populateCameras();
  
  if ('BarcodeDetector' in window){
    try{
      const supported = await BarcodeDetector.getSupportedFormats();
      if (supported && supported.includes('qr_code')){
        barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
        detectorSupport.textContent = 'SÃ­ (qr_code)';
      } else {
        detectorSupport.textContent = 'No (qr_code no soportado)';
      }
    }catch(e){
      console.warn('BarcodeDetector init err', e);
      detectorSupport.textContent = 'No (error)';
    }
  } else {
    detectorSupport.textContent = 'No';
  }

  refreshUI();
})();
</script>
</body>
</html>
